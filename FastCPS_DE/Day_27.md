### 5. 샤딩

- **샤딩이란**
    - **샤딩의 정의**

        **대량의 데이터를 여러 물리적인 위치 또는 데이터베이스 서버에 저장하는 과정 또는 방법**을 말한다. **scale-up으로는 한계**가 있기 때문에 **scale-out을 하면서도 데이터베이스의 일관된 기능을 사용할 수 있도록 하는 방법**이다. 각 데이터베이스 **서버는 샤드라고 하는 데이터 조각**(chunk)를 가지고, 해당 조각에 대해서는 해당 데이터베이스의 기본 동작을 한다.

    - **샤딩이 필요한 이유**

        데이터 베이스는 한 번 구축하면 변경하기 힘든 인프라이다. 서비스의 유저나 데이터는 어느 기간에 얼마만큼 늘지 쉽게 예측할 수 없다. 데이터가 많아지면 데이터베이스가 병목이 되는 지점이 나타난다. 데**이터의 스키마나 활용도(기능)는 기존과 동일하게 유지**하면서도 **더 많은 데이터를 저장하고 사용**할 수 있는 방법이 필요하다.

    - **샤딩의 장점**
        1. **응답 시간**

            한 대의 서버에서 대량의 데이터 전체를 검색해야한다면, 검색에 쓸수 있는 컴퓨팅 리소스(cpu, ram)가 제한되어있기 때문에 오래걸린다. 샤딩은 물론 **네트워크를 사용하는 시간이 추가**되지만, 대량의 데이터에 대해서 **리소스를 나누어서 조회할 수 있으므로 시간이 단축**될 수 있다.
        2. **HA의 용이성**

            서버와 샤드가 여러개로 나누어져있고, 샤드에 대한 복제본을 물리적으로 다른 서버에서 유지하거나, 불러올 수 있으면, 일부 서버를 이용할 수 없게 되더라도 전체 데이터 사용에는 문제가 없도록 만들 수 있다. 대규모의 단일 서버에 대해서 **사용하지 않는 백업 서버를 두는 것보다, 장애 방지와 복구에 드는 비용이 적다**.

        3. 유연성, 자원의 효율적인 사용

            **scale-up 보다 작은 사이즈로 scale-out을 하는 것이 컴퓨팅 리소스 사용에 더 효과적**이다. 데이터가 줄어든다면, **scale-in이 scale-down 보다 쉽고 안전한 선택**이다.

    - **샤딩의 단점**

        샤딩은 완벽한 솔루션이 아니다. 위의 장점을 얻으면 단점 또한 있다.

        1. **데이터 핫스팟**

            특정 샤드에 데이터가 많아져서, 다시 샤딩이 필요해지거나, 다른 샤드들의 여유공간이 많이 남는등 **불균형이 발생**하는 것
        2. **복잡도**

            샤딩을 했다면 샤딩키를 지정하거나 찾기위한 어플리케이션에 추가적인 **로직이나, 설정이 필요할 수 있다**. 뿐만 아니라 샤딩되지 않은 것을 샤딩하거나, 샤딩된 것에 조정이 필요하면 복잡도는 더욱 커진다.
        3. **비용**

            **서버의 수, 인스턴스의 수가 많아**지므로 같은 사이즈의 scale-up 보다는 **인프라 비용, 관리비용이 더 많이 든다**.

- **샤딩의 동작 방식**

    - **샤딩키**

        물리적으로 데이터를 나누려면 **어떤 기준으로 데이터를 나눌지 설정**해야한다. **샤딩에 사용되는 조건을 샤딩 키**라고 한다. 샤딩 키의 값에 따라서 위치할 물리적인 샤드가 결정된다.
        - 예. 국가/위치 정보, user_id 의 해시값, 날짜의 범위 등

    - **샤딩 방법 - Range**

        **데이터의 범위에 따라서 데이터베이스의 로우를 분리해서 샤드에 위치**시킨다. 날짜의 범위, 숫자의 범위, 문자열의 범위 순서 (Lexicographic order) 에 따라서 분리하는 방법이다.

        **장점**
        - 구현이 쉽다.
        - 키의 값을 보고 어느 샤드에 위치할 지 알 수 있다.
        - 샤드의 장애, 또는 유실시 어떤 데이터가 영향받았는지 알기 쉽다.

        **단점**
        - 데이터의 사이즈가 균일하지 않을 수 있다. Skew
        - 오버로드가 발생할 수 있다.
        - 리샤딩이 필요할 수 있다.

        MySQL에서 지원한다.

    - **샤딩 방법 - Hash**

        **샤딩 키를 Hash 한 결과를 이용**해서 샤드를 결정하는 방식. **랜덤하게 고르게 분산할 수 있을 것으로 기대**한다.

        **장점**
        - 샤딩 키에 따른 편중 없이 고르게 데이터를 분산할 수 있다.

        **단점**
        - 샤딩키의 특정 값에 편중이 있다면, 데이터가 고르게 분산되지 않을 수 있다. (heavy user 등)
        - 샤드가 추가되거나 조정될 때 해시값을 다시 조정하기 어렵다.
            - consistent hash 로 부담을 완화 가능

        MySQL에서 지원한다.

    - **샤딩 방법 - Directory**

        샤딩 키의 값이 미리 정해져 있고, **해당하는 값은 해당하는 샤드로 배치**시키는 방식이다. distinct value가 이미 정해져 있고, cardinality 가 변할 일이 적어야 한다.

        **장점**
        - 값으로 샤드가 확정적으로 정해진다.
        - 운영의 복잡도가 낮다.

        **단점**
        - 잘못된 정보가 있으면 샤딩에 실패할 수 있다.

    - **샤딩 방법 - Geo**

        **샤딩키에 위치정보가 사용**되고, 실제로 **샤드를 위치한 물리적인 주소가 해당 지역과 가까운 곳에 위치** 시키는 방법

        **장점**
        - 응답속도가 빠르다.

        **단점**
        - 데이터가 고르게 분산되지 않을 수 있다.
        - grey zone 이 발생하는 경우 해결책을 찾아야 한다.

- **샤딩의 주요 고려사항**

    샤딩을 통해서 데이터의 조회속도를 높이고 시스템을 안정적이게 만들려고 했는데, 실제로 그렇지 않을 수 있다. 사전에, 또는 이후에 어떤 요소를 고려해야하는지 살펴본다.
    - **Cardinality**

        Cardinality: **해당 컬럼에서 unique(distinct)한 값의 종류가 얼마나 많은지**. **Hash와 같은 방법을 쓴다면 카디널리티가 높은 컬럼이 적합**하다. 반대로 카디널리티가 낮은 컬럼으로 해시를 사용한다면, 해시의 장점을 얻기 힘들다.

    - **확률**

        **특정 정보가 특정 샤드에 저장될 확률**. **Range, Hash 등의 방법을 사용할 때** 고려해야 한다. 샤딩키에 해당하는 값에 편중이 생기면 설계와 다른 결과가 나타나거나, 핫스팟이 생길 수 있다

    - **변화**

        설계한 것과 다른 유저의 행동이나 트래픽의 유입이 있다면, 샤드 사이의 skew 가 발생하기 쉽다. **샤딩키를 정했다면 데이터의 변화와 데이터베이스 샤드 사이즈의 변화를 지속적으로 관찰**해야 한다.